# 2. プロンプトエンジニアリング

ここでは Claude Code に限らず、Claude を使うときの基本的なプロンプト設計を整理します。
ジュニアでも成果が出る形にしつつ、シニア向けに「再現性」を重視しています。

## 2.1 まず「成功条件」と「評価」を明文化する
プロンプトは **「成功条件の翻訳」** です。
以下の 3 点を最初に書くことで、出力が安定します。

- **目的**: 何を達成したいか
- **制約**: 変更範囲、守るルール、禁則
- **完了条件**: 何が出たら成功か（例: テストが通る、差分が小さい）

さらに、評価の観点（テスト・レビュー基準）も書いておくと改善が速くなります。

## 2.2 クリアで具体的な指示
公式ガイドでも「明確さと具体性」が最重要とされています。

- 曖昧語を避ける（「いい感じに」ではなく「このファイルのこの関数を修正」）
- 対象範囲を絞る（フォルダ、ファイル、機能）
- 出力形式を指定（箇条書き、差分、コードブロック）

## 2.3 役割・立場の指定

- 役割を与えると「注意点や視点」が固定される
- 例: 「あなたはコードレビュアー」「セキュリティ担当」

## 2.4 例示（Few-shot）

- 「良い例」を 1 つ書くだけで精度が上がる
- 例が長い場合は **“理想の部分だけ”** を示す

## 2.5 XML タグで構造化
長いプロンプトは XML タグで構造を示すと安全です。

```
<goal>目的</goal>
<constraints>制約</constraints>
<context>前提情報</context>
<output_format>出力形式</output_format>
```

## 2.6 チェーン化（分割統治）
一発で全部やらせるより、**小さく分割して連鎖させる** 方が安定します。

- Step 1: 調査と現状把握
- Step 2: 方針の提示
- Step 3: 実装
- Step 4: 検証

### 2.6.1 「質問フェーズ」を明示する
最初に「不明点があれば質問して」と書くだけで、
誤解による手戻りが大きく減ります。

例:
```
不足情報があれば、実装に入る前に質問してください。
```

### 2.6.2 「計画フェーズ」を明示する
まず計画だけ出させると安全です。

例:
```
まずは変更方針と影響範囲だけ提案してください。
実装は確認後に進めます。
```

### 2.6.3 「検証フェーズ」を明示する
実装後の検証方法も合わせて指定します。

例:
```
変更後に実行すべきテストとコマンドを列挙してください。
```

## 2.7 よく使うテンプレ

```
<goal>
X を実現したい
</goal>

<constraints>
- 変更範囲: A のみ
- 既存仕様を壊さない
- コード規約を守る
</constraints>

<context>
- 設計資料: docs/xxx.md
- 対象ファイル: app/xxx.py
</context>

<output_format>
- 変更理由
- 変更ファイル一覧
- 差分
</output_format>
```

## 2.8 実務での注意点
- 「わからないことがあれば質問して」と添える
- 安全性が必要なら「確認してから実行」も明記
- “探索フェーズ” と “実装フェーズ” を分ける

### 2.8.1 非目標（Non-goals）を入れる
作業範囲が広がりすぎるのを防ぐため、
「やらないこと」を書くのが有効です。

例:
```
非目標: UI デザインや API 仕様の変更はしない
```

### 2.8.2 リスクの高い操作は事前承認
破壊的変更や大きなリファクタは、
「実行前に確認する」方針を明記します。

## 2.9 例（良いプロンプト）
```
<goal>
API レスポンスの並び順を「作成日降順」に変更したい
</goal>

<constraints>
- 変更範囲: app/api/search.py のみ
- 既存テストは壊さない
</constraints>

<context>
- 仕様: docs/requirements.md
- 対象: app/api/search.py
</context>

<output_format>
- 変更理由
- 変更ファイル一覧
- 差分
</output_format>
```

## 2.9.1 良い / 悪いの比較

| 観点 | 悪い例 | 良い例 |
| --- | --- | --- |
| 目的 | いい感じに改善しておいて | 並び順を created_at 降順に統一する |
| 変更範囲 | 指定なし | app/api/search.py のみ |
| 完了条件 | 指定なし | 既存テストが通る |

## 2.10 アンチパターン
- 「いい感じにして」だけの依頼
- 参照資料が多すぎる（特に古い資料）
- 完了条件がない（何が成功かわからない）

## 2.11 追加パターン集
**レビュー依頼**
```
目的: 変更点のリスク確認
制約: 重大なバグリスクのみ指摘
完了条件: 3 つ以内で指摘が出る
```

**テスト追加依頼**
```
目的: 既存バグの再発防止
制約: 既存テストを変更しない
完了条件: 新規テストが 1 つ以上
```

## 2.12 練習
- 自分のタスクを上のテンプレに当てはめて書いてみる
- 書いた後に「制約が足りない」と思う点を 1 つ追加する

### 演習テンプレ
目的: 明確なプロンプトを作る
入力: いまのタスク 1 件
出力:
```
<goal>
</goal>

<constraints>
- 
</constraints>

<context>
- 
</context>

<output_format>
- 
</output_format>

<non_goals>
- 
</non_goals>

<verification>
- 
</verification>
```

### 解答例
```
<goal>
検索結果の並び順を created_at 降順に統一したい
</goal>

<constraints>
- 変更範囲: app/api/search.py のみ
- 既存テストを壊さない
</constraints>

<context>
- 仕様: docs/requirements.md
- 対象: app/api/search.py
</context>

<output_format>
- 変更理由
- 変更ファイル一覧
- 差分
</output_format>

<non_goals>
- UI 表示の変更はしない
</non_goals>

<verification>
- 既存テストを実行
</verification>
```

## 2.13 チェックリスト
- 目的が具体的
- 制約が明確
- 参照すべきドキュメントが明示されている
- 出力形式が指定されている

## 参考
- https://platform.claude.com/docs/ja/build-with-claude/prompt-engineering/overview
- https://code.claude.com/docs/en/best-practices
