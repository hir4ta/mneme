# 3. コンテキストエンジニアリング

Claude Code の失敗原因の多くは「必要な情報が入っていない」か「情報が多すぎる」かのどちらかです。
この章では、**必要最小限で最大の成果を出す** コンテキスト設計を解説します。

## 3.1 何を入れるか / 入れないか

### 入れるべきもの（優先順位）
1. **目的と完了条件**
2. **設計・要件**（正本のドキュメント）
3. **対象ファイルと範囲**
4. **禁止事項・制約**

### 入れないべきもの
- 変更対象と関係ない過去ログ
- 既に古くなった設計
- “とりあえず” の参考資料

## 3.2 CLAUDE.md を「薄く」保つ
CLAUDE.md は **“常に読み込まれる前提”** の文書なので、内容は短く保つのが鉄則です。

- 目的は「プロジェクト共通の最低限ルール」だけ
- 大きな仕様や手順は別ドキュメントに逃がす
- 変更時はチームで合意を取る

公式では `/init` でスターターを生成する方法が案内されていますが、
**コミュニティでは「自動生成に頼りすぎず、必ず手で削る」ことが推奨**されています。

## 3.3 CLAUDE.md の配置と分割
Claude Code は複数の CLAUDE.md を読み込めます。

- `~/.claude/CLAUDE.md`（全プロジェクト共通）
- `./CLAUDE.md`（プロジェクトルート）
- 親ディレクトリ／子ディレクトリ（必要時に読み込み）

**@参照**で別のドキュメントを読み込ませることも可能です。

## 3.4 .claude/rules で動的に切り替える
ファイルや領域ごとにルールを分けると、コンテキストが急に重くならずに済みます。

- `/frontend/**` に UI ルール
- `/backend/**` に API ルール
- `/infra/**` にインフラの注意点

**原則**: ルールは「必要な場面だけ読み込ませる」。

## 3.5 コンテキストパックの作り方
「今この作業で必要なものだけをまとめた最小セット」を作ると精度が上がります。

例:
```
- 目的: 検索結果の並び順変更
- 正本: docs/requirements.md
- 対象: app/api/search.py
- 既知の制約: 並び順は created_at 降順
```

## 3.6 「情報の粒度」を揃える
混在する粒度は誤解の原因です。

- 仕様は「仕様だけ」
- 実装の指示は「実装の指示だけ」
- 参考リンクは「補助」に限定

## 3.7 コンテキストの圧縮と整理
- 作業が長くなったら **要約（/compact）** を使う
- 重要な決定は CLAUDE.md や設計 doc に反映する
- 作業後は「学び」をルール化して次回コストを下げる

## 3.8 例（悪い / 良い）

| 観点 | 悪い例 | 良い例 |
| --- | --- | --- |
| 参照資料 | 過去の議事録や古い設計リンクを大量に貼る | 正本の仕様に絞る |
| 対象 | 不明 | `app/api/search.py` |
| 制約 | 書かない | 並び順は created_at 降順 |

## 3.9 練習
- いまのプロジェクトで「正本ドキュメント」を 1 つ選ぶ
- それ以外の資料は一旦外す

### 演習テンプレ
目的: コンテキストを最小に整理する
入力: 正本ドキュメント + 対象ファイル
出力:
```
正本ドキュメント:
対象ファイル:
不要な資料（外す）:
追加で欲しい情報:
```

### 解答例
```
正本ドキュメント: docs/requirements.md
対象ファイル: app/api/search.py
不要な資料（外す）: 1年前の仕様メモ、旧Wiki
追加で欲しい情報: API の並び順に関する仕様の該当箇所
```

## 3.10 チェックリスト
- 参照資料の数は 3 つ以内
- 変更対象が 1 つ以上明示されている
- ルールは短く保たれている

## 参考
- https://www.humanlayer.dev/blog/writing-a-good-claude-md
- https://code.claude.com/docs/en/best-practices
- https://zenn.dev/tmasuyama1114/articles/claude_code_dynamic_rules
- https://zenn.dev/hiraoku/scraps/de8a8f86d6e25d
- https://docs.claude.com/en/docs/claude-code/slash-commands
